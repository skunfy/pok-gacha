<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion ‚Äî Pok√©gacha</title>
  <style>
    :root{ --bg1:#05060d; --bg2:#090b18; }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      color:#fff;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(80,130,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(255,80,220,.18), transparent 62%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
    }
    .cornerLogo{
      position: fixed;
      top: 18px;
      left: 18px;
      width: 110px;
      z-index: 10000;
    }
    .cornerLogo img{width:100%; height:auto; display:block}

    .card{
      width:min(520px, 92vw);
      border-radius:18px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 140px rgba(0,0,0,.65);
      padding:16px;
    }
    h1{margin:0 0 6px 0; font-size:18px; letter-spacing:.6px}
    p{margin:0 0 14px 0; opacity:.75; font-size:13px}
    .row{display:grid; gap:10px}
    input{
      padding:12px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:#fff; outline:none;
      font-weight:700;
    }
    button{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#fff;font-weight:900;cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    button:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    button:active{transform: translateY(0px) scale(.99)}
    button:disabled{opacity:.6; cursor:not-allowed; transform:none}

    .msg{margin-top:10px; font-size:13px; opacity:.9; white-space:pre-line;}
    .muted{opacity:.7; font-size:12px; margin-top:10px}

    .codeBox{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      display:none;
      gap:10px;
    }
    .codeTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .codeValue{
      font-weight:1000;
      letter-spacing:2px;
      font-size:20px;
      user-select:text;
    }
    .codeActions{display:flex; gap:10px; flex-wrap:wrap}
    .btnSmall{
      padding:9px 10px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
    }
  </style>
</head>
<body>
  <a class="cornerLogo" href="/" aria-label="Accueil">
    <img src="poke.png" alt="Logo" />
  </a>

  <div class="card">
    <h1>Connexion</h1>
    <p>Choisis un pseudo. Si c‚Äôest ton 1er login, un code sera cr√©√©. Sinon, entre ton code.</p>

    <div class="row">
      <input id="name" placeholder="Pseudo (ex: Alex)" autocomplete="nickname" />
      <input id="code" placeholder="Code (si d√©j√† cr√©√©)" autocomplete="one-time-code" />
      <button id="btn">SE CONNECTER</button>
    </div>

    <div class="codeBox" id="codeBox">
      <div class="codeTop">
        <div>
          <div style="opacity:.75;font-size:12px;font-weight:800;margin-bottom:4px;">TON CODE (√† garder)</div>
          <div class="codeValue" id="codeValue">000000</div>
        </div>
        <div class="codeActions">
          <button class="btnSmall" id="copyBtn">COPIER</button>
          <button class="btnSmall" id="continueBtn">J‚ÄôAI NOT√â ‚Üí CONTINUER</button>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        ‚ö†Ô∏è Si tu perds ce code, tu ne pourras plus r√©cup√©rer ton compte.
      </div>
    </div>

    <div class="msg" id="msg"></div>
    <div class="muted">üí° Tu peux partager ton pseudo + code √† tes amis si tu veux qu‚Äôils se connectent au m√™me compte (sinon chacun a le sien).</div>
  </div>

  <script>
    const TOKEN_KEY = "gacha_token_v1";

    const nameEl = document.getElementById("name");
    const codeEl = document.getElementById("code");
    const msgEl = document.getElementById("msg");
    const btn = document.getElementById("btn");

    const codeBox = document.getElementById("codeBox");
    const codeValue = document.getElementById("codeValue");
    const copyBtn = document.getElementById("copyBtn");
    const continueBtn = document.getElementById("continueBtn");

    // D√©j√† connect√© ? -> index
    if(localStorage.getItem(TOKEN_KEY)){
      window.location.href = "/index.html";
    }

    function showMsg(t){ msgEl.textContent = t || ""; }

    async function login(){
      showMsg("");
      codeBox.style.display = "none";
      btn.disabled = true;

      try{
        const name = (nameEl.value || "").trim();
        const code = (codeEl.value || "").trim();

        const r = await fetch("/api/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name, code })
        });

        const data = await r.json().catch(()=> ({}));
        if(!r.ok){
          showMsg(data.error || ("Erreur " + r.status));
          return;
        }

        // on stocke le token
        localStorage.setItem(TOKEN_KEY, data.token);

        // Nouveau compte -> on montre le code et on ATTEND
        if(data.isNew){
          codeValue.textContent = data.code;
          codeBox.style.display = "block";
          showMsg("Compte cr√©√© ‚úÖ\nCopie/notes ton code puis clique sur ‚ÄúCONTINUER‚Äù.");
          return;
        }

        // Compte existant -> on va direct
        window.location.href = "/index.html";

      }catch(e){
        showMsg("Erreur r√©seau. R√©essaie.");
      }finally{
        btn.disabled = false;
      }
    }

    btn.onclick = login;
    codeEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });
    nameEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });

    copyBtn.onclick = async () => {
      try{
        await navigator.clipboard.writeText(codeValue.textContent);
        showMsg("‚úÖ Code copi√© !");
      }catch{
        showMsg("Copie manuelle: s√©lectionne le code et fais Ctrl+C");
      }
    };

    continueBtn.onclick = () => {
      window.location.href = "/index.html";
    };
  </script>
</body>
</html>