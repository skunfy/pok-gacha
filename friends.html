<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Friends — Pokégacha</title>

  <style>
    :root{ --bg1:#05060d; --bg2:#090b18; }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      color:#fff;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(80,130,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(255,80,220,.18), transparent 62%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
      overflow-x:hidden;
    }

    .wrap{
      width:min(1100px,94vw);
      margin: 24px auto 40px;
      display:grid;
      gap:16px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:14px;
      border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter:blur(10px);
    }
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    button, input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      outline:none;
    }
    button{cursor:pointer; transition:transform .12s ease, background .12s ease}
    button:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    button:active{transform: translateY(0px) scale(.99)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .panel{
      border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding:16px;
      backdrop-filter:blur(10px);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid2{grid-template-columns:1fr}
    }

    .titleRow{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap}
    .titleRow h2{margin:0; font-size:16px; letter-spacing:.5px}
    .muted{opacity:.75; font-size:12px}

    .codeBox{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .codeVal{
      font-weight:1000;
      letter-spacing:2px;
      font-size:18px;
      user-select:text;
    }
    .msg{margin-top:10px; font-size:13px; white-space:pre-line; opacity:.92}

    .friendsList{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .friendItem{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.15);
      font-weight:1000;
      letter-spacing:1px;
      font-size:12px;
      user-select:text;
    }
    .spacer{flex:1 1 auto}
    .smallBtn{padding:9px 10px; font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div><b>POKÉGACHA</b> — Friends</div>
      <div class="controls">
        <button onclick="location.href='/index.html'">← Retour</button>
        <button onclick="location.href='/collection.html'">Collection</button>
      </div>
    </div>

    <div class="grid2">
      <div class="panel">
        <div class="titleRow">
          <h2>Ton Friend Code</h2>
          <div class="muted">Partage-le pour qu’on t’ajoute</div>
        </div>

        <div class="codeBox">
          <div class="codeVal" id="myCode">----</div>
          <button class="smallBtn" id="copyMyCode">COPIER</button>
        </div>

        <div class="msg" id="msgMe"></div>
      </div>

      <div class="panel">
        <div class="titleRow">
          <h2>Ajouter un ami</h2>
          <div class="muted">Entre son code (ex: ABCD-EF12)</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <input id="addCode" placeholder="ABCD-EF12" style="flex:1 1 220px; text-transform:uppercase;" />
          <button id="addBtn">AJOUTER</button>
        </div>

        <div class="msg" id="msgAdd"></div>
      </div>
    </div>

    <div class="panel">
      <div class="titleRow">
        <h2>Mes amis</h2>
        <div class="muted">Clique “Voir collection” pour consulter</div>
      </div>

      <div class="friendsList" id="list"></div>
      <div class="msg" id="msgList"></div>
    </div>
  </div>

  <script>
    const TOKEN_KEY = "gacha_token_v1";
    const token = localStorage.getItem(TOKEN_KEY);
    if(!token) location.href="/login.html";

    async function api(path, opts={}){
      const r = await fetch(path, {
        ...opts,
        headers: {
          ...(opts.headers || {}),
          "Authorization": "Bearer " + localStorage.getItem(TOKEN_KEY),
          "Content-Type": "application/json"
        }
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data.error || ("HTTP " + r.status));
      return data;
    }

    const myCodeEl = document.getElementById("myCode");
    const copyMyCodeBtn = document.getElementById("copyMyCode");
    const msgMe = document.getElementById("msgMe");

    const addCodeEl = document.getElementById("addCode");
    const addBtn = document.getElementById("addBtn");
    const msgAdd = document.getElementById("msgAdd");

    const list = document.getElementById("list");
    const msgList = document.getElementById("msgList");

    function show(el, t){ el.textContent = t || ""; }

    function friendRow(f){
  const wrap = document.createElement("div");
  wrap.className = "friendItem";
  wrap.innerHTML = `
    <div><b>${escapeHtml(f.name || "Ami")}</b></div>
    <div class="badge">${escapeHtml(f.friendCode || "----")}</div>
    <div class="spacer"></div>
    <button class="smallBtn viewProfileBtn">Profil</button>
    <button class="smallBtn viewCollectionBtn">Voir collection</button>
  `;

  wrap.querySelector(".viewCollectionBtn").onclick = () => {
    location.href = "/friend_collection.html?code=" + encodeURIComponent(f.friendCode);
  };

  wrap.querySelector(".viewProfileBtn").onclick = () => {
    location.href = "/friend_profile.html?code=" + encodeURIComponent(f.friendCode);
  };

  return wrap;
}

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function loadMe(){
      try{
        const me = await api("/api/me", { method:"GET", headers:{} });
        myCodeEl.textContent = me.friendCode || "----";
        show(msgMe, me.friendCode ? "✅ OK" : "⚠️ Friend code manquant (réessaie / refresh)");
      }catch(e){
        show(msgMe, "Erreur: " + e.message);
      }
    }

    async function loadFriends(){
      list.innerHTML = "";
      show(msgList, "Chargement...");
      try{
        const data = await api("/api/friends", { method:"GET", headers:{} });
        const friends = data.friends || [];
        if(!friends.length){
          show(msgList, "Aucun ami pour l’instant.");
          return;
        }
        show(msgList, "");
        friends.forEach(f => list.appendChild(friendRow(f)));
      }catch(e){
        show(msgList, "Erreur: " + e.message);
      }
    }

    async function addFriend(){
      show(msgAdd, "");
      addBtn.disabled = true;

      try{
        const friendCode = (addCodeEl.value || "").trim().toUpperCase();
        if(!friendCode) { show(msgAdd, "Entre un code."); return; }

        await api("/api/friends/add", {
          method:"POST",
          body: JSON.stringify({ friendCode })
        });

        show(msgAdd, "✅ Ami ajouté !");
        addCodeEl.value = "";
        await loadFriends();
      }catch(e){
        show(msgAdd, "❌ " + e.message);
      }finally{
        addBtn.disabled = false;
      }
    }

    addBtn.onclick = addFriend;
    addCodeEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addFriend(); });

    copyMyCodeBtn.onclick = async () => {
      try{
        await navigator.clipboard.writeText(myCodeEl.textContent);
        show(msgMe, "✅ Copié !");
      }catch{
        show(msgMe, "Copie manuelle: sélectionne le code et Ctrl+C");
      }
    };

    (async () => {
      await loadMe();
      await loadFriends();
    })();
  </script>
</body>
</html>