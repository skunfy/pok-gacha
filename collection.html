<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Collection ‚Äî Pok√©gacha</title>

<style>
.slab{
  width:380px;
  height:560px;
  border-radius:22px;
  position:relative;
}

.shell{
  position:absolute;
  inset:0;
  border-radius:22px;
  background:linear-gradient(145deg, rgba(255,255,255,.14), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.18);
  backdrop-filter:blur(6px);
}

.label{
  position:absolute;
  left:50%;
  top:30px;
  transform:translateX(-50%);
  width:85%;
  height:60px;
  border-radius:14px;
  background:rgba(0,0,0,.3);
  border:1px solid rgba(255,255,255,.2);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 12px;
}

.grade{
  font-size:24px;
  font-weight:900;
}

.mintBadge{
  padding:5px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(255,80,80,.6);
  color:#ff5050;
  display:none;
}

.cardImg{
  position:absolute;
  left:50%;
  top:58%;
  transform:translate(-50%,-50%);
  width:300px;
  height:420px;
  background:center/contain no-repeat;
  border-radius:16px;
}

:root{
  --bg1:#05060d;
  --bg2:#090b18;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  font-family:system-ui;
  color:#fff;
  background:
    radial-gradient(900px 520px at 20% 10%, rgba(80,130,255,.22), transparent 60%),
    radial-gradient(900px 600px at 85% 30%, rgba(255,80,220,.18), transparent 62%),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  background-attachment: fixed;
  overflow-x:hidden;
}
.wrap{
  width:min(1200px,95vw);
  margin:24px auto;
  display:grid;
  gap:16px;
}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-radius:16px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  backdrop-filter:blur(10px);
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
input, select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:#0f111a;
  color:#fff;
  font-weight:600;
}
button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}
.gridWrap{
  border-radius:16px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  padding:20px;
  max-height:820px;
  overflow:auto;
}
.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
}
.cardBox{
  background:rgba(255,255,255,.06);
  border-radius:14px;
  padding:12px;
  border:1px solid rgba(255,255,255,.12);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.cImg{
  height:220px;
  background:center/contain no-repeat;
  border-radius:10px;
  cursor:pointer;
}
.sellBtn{
  margin-top:auto;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  place-items:center;
  z-index:9999;
}
.modal.open{display:grid}

/* ===== Foil overlay (zoom) ===== */
.foilWrap{
  position:absolute;
  left:50%;
  top:58%;
  transform:translate(-50%,-50%);
  width:300px;
  height:420px;
  border-radius:16px;
  overflow:hidden;
  pointer-events:none;
}

.foilShine, .foilGlare{
  position:absolute;
  inset:-35%;
  border-radius:24px;
  opacity:0;
  transition: opacity .20s ease;
  will-change: transform;
}

.foilShine{
  background:
    radial-gradient(circle at 30% 30%,
      rgba(255,255,255,.55),
      rgba(255,255,255,.16),
      rgba(255,255,255,0) 62%);
  mix-blend-mode: screen;
  filter: blur(9px);
  transform: translate(-20px,-10px);
}

.foilGlare{
  background:
    linear-gradient(120deg,
      rgba(255,255,255,0) 33%,
      rgba(255,255,255,.30) 50%,
      rgba(255,255,255,0) 67%);
  mix-blend-mode: overlay;
  filter: blur(11px);
  transform: translate(20px,10px) rotate(10deg);
}

.foilRainbow{
  position:absolute;
  inset:-40%;
  border-radius:30px;
  opacity:0;
  transition: opacity .25s ease;
  pointer-events:none;

  background: linear-gradient(
    115deg,
    rgba(255,0,120,.25),
    rgba(0,220,255,.25),
    rgba(255,220,0,.20),
    rgba(0,255,140,.20),
    rgba(180,0,255,.25)
  );

  mix-blend-mode: soft-light;
  filter: blur(18px);
  will-change: transform;
}

@keyframes foilMoveRainbow{
  0%   { transform: translate(40px,-30px) rotate(0deg); }
  50%  { transform: translate(-40px,30px) rotate(15deg); }
  100% { transform: translate(40px,-30px) rotate(0deg); }
}

.modal.open .foilRainbow{
  opacity: .30;
  animation: foilMoveRainbow 4s ease-in-out infinite;
}

.modal.open .foilShine{ opacity:.35; }
.modal.open .foilGlare{ opacity:.25; }

@keyframes foilMoveShine{
  0%   { transform: translate(-35px,-25px) scale(1); }
  50%  { transform: translate(35px,25px) scale(1.05); }
  100% { transform: translate(-35px,-25px) scale(1); }
}
@keyframes foilMoveGlare{
  0%   { transform: translate(40px,20px) rotate(18deg); }
  50%  { transform: translate(-40px,-20px) rotate(-18deg); }
  100% { transform: translate(40px,20px) rotate(18deg); }
}

.modal.open .foilShine{ animation: foilMoveShine 2.8s ease-in-out infinite; }
.modal.open .foilGlare{ animation: foilMoveGlare 3.6s ease-in-out infinite; }

/* Scrollbar dark */
.gridWrap{
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,.18) rgba(255,255,255,.06);
}
.gridWrap::-webkit-scrollbar{ width: 10px; }
.gridWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
.gridWrap::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.25);
}
.gridWrap::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.28); }
.gridWrap{ scrollbar-gutter: stable both-edges; }
</style>
</head>

<body>

<div class="wrap">

  <div class="topbar">
    <div><b>POK√âGACHA</b> ‚Äî Collection</div>

    <div class="controls">
      <!-- ‚úÖ FILTRE JEU -->
      <select id="gameSel" title="Jeu">
        <option value="pokemon">Pok√©mon</option>
        <option value="onepiece">One Piece</option>
      </select>

      <input id="search" placeholder="Rechercher...">

      <select id="sort">
        <option value="recent">Derni√®res obtenues</option>
        <option value="grade">Meilleure note</option>
        <option value="name">Nom A-Z</option>
      </select>

      <button onclick="location.href='/market.html'">MARKET</button>
      <button onclick="location.href='/friends.html'">FRIENDS</button>
      <button onclick="location.href='/'">‚Üê Retour</button>
    </div>
  </div>

  <div class="gridWrap">
    <div class="grid" id="grid"></div>
  </div>

</div>

<div class="modal" id="modal">
  <div class="slab" id="zoomSlab" data-tier="" data-mint="0">
    <div class="shell"></div>

    <div class="label">
      <div id="zoomTitle">POK√âMON</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div class="mintBadge" id="zoomMint">MINT</div>
        <div class="grade" id="zoomGrade">?</div>
      </div>
    </div>

    <div class="cardImg" id="zoomImg"></div>

    <div class="foilWrap">
      <div class="foilShine" id="foilShine"></div>
      <div class="foilGlare" id="foilGlare"></div>
      <div class="foilRainbow"></div>
    </div>
  </div>
</div>

<script>
const TOKEN_KEY = "gacha_token_v1";
const GAME_KEY  = "gacha_game_v1";

const TOKEN = localStorage.getItem(TOKEN_KEY);
if(!TOKEN) location.href="/login.html";

function currentGame(){
  const g = String(localStorage.getItem(GAME_KEY) || "pokemon").toLowerCase();
  return (g === "onepiece") ? "onepiece" : "pokemon";
}

async function api(path, opts = {}){
  const g = encodeURIComponent(currentGame());
  const sep = path.includes("?") ? "&" : "?";
  const url = path + sep + "game=" + g;

  const r = await fetch(url, {
    ...opts,
    headers: {
      ...(opts.headers || {}),
      Authorization: "Bearer " + TOKEN,
      "Content-Type": "application/json",
    }
  });

  const data = await r.json().catch(() => ({}));
  if(!r.ok) throw new Error(data.error || ("HTTP " + r.status));
  return data;
}

const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const sortSelect = document.getElementById("sort");
const gameSel = document.getElementById("gameSel");

const modal = document.getElementById("modal");
const zoomSlab = document.getElementById("zoomSlab");
const zoomImg = document.getElementById("zoomImg");
const zoomTitle = document.getElementById("zoomTitle");
const zoomGrade = document.getElementById("zoomGrade");
const zoomMint = document.getElementById("zoomMint");

let allItems = [];

gameSel.value = currentGame();
gameSel.addEventListener("change", async () => {
  localStorage.setItem(GAME_KEY, gameSel.value);
  await loadCollection();
});

function tierFromGrade(g){
  if(g >= 10) return "g";
  if(g >= 7) return "v";
  if(g >= 5) return "b";
  return "w";
}

async function loadCollection(){
  try{
    const data = await api("/api/collection");
    allItems = data.items || [];
    applyFilters();
  }catch(e){
    localStorage.removeItem(TOKEN_KEY);
    location.href="/login.html";
  }
}

function applyFilters(){
  const q = searchInput.value.toLowerCase().trim();
  let items = [...allItems];

  if(q){
    items = items.filter(item =>
      (item.name || "").toLowerCase().includes(q) ||
      (item.set || item.setName || "").toLowerCase().includes(q) ||
      String(item.grade || "").includes(q)
    );
  }

  const sort = sortSelect.value;
  if(sort === "grade"){
    items.sort((a,b)=> (b.grade||0) - (a.grade||0));
  } else if(sort === "name"){
    items.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  } else {
    items.sort((a,b)=> (b.lastAt||0) - (a.lastAt||0));
  }

  render(items);
}

function openZoom(x){
  let img = x.image;

  // ‚úÖ seulement Pok√©mon: low.webp -> high.webp
  if (currentGame() === "pokemon" && img && img.includes("/low.webp")) {
    img = img.replace("/low.webp", "/high.webp");
  }

  zoomImg.style.backgroundImage = `url('${img}')`;
  zoomTitle.textContent = `${x.name} ‚Ä¢ ${x.set || x.setName || ""}`;
  zoomGrade.textContent = x.grade;

  zoomSlab.dataset.tier = tierFromGrade(x.grade);
  zoomSlab.dataset.mint = x.mint ? "1" : "0";
  zoomMint.style.display = x.mint ? "block" : "none";

  modal.classList.add("open");
}

function render(items){
  grid.innerHTML="";
  items.forEach(x=>{
    const el=document.createElement("div");
    el.className="cardBox";

    const gameTag = (x.game || currentGame()) === "onepiece" ? "üü• One Piece" : "üü® Pok√©mon";

    el.innerHTML=`
      <div class="cImg" style="background-image:url('${x.image}')"></div>
      <div style="opacity:.75;font-size:12px;">${gameTag}</div>
      <div><b>${x.name}</b></div>
      <div>${x.set || x.setName || ""}</div>
      <div>Grade ${x.grade} ${x.mint?"(MINT)":""} √ó${x.count}</div>
      <button class="sellBtn">VENDRE +1üíµ</button>
    `;

    el.querySelector(".cImg").onclick = () => openZoom(x);

    el.querySelector(".sellBtn").onclick = async () => {
      try{
        await api("/api/sell",{
          method:"POST",
          body: JSON.stringify({ idKey: x.idKey })
        });
        await loadCollection();
      }catch{}
    };

    grid.appendChild(el);
  });
}

searchInput.addEventListener("input", applyFilters);
sortSelect.addEventListener("change", applyFilters);

modal.onclick = e => {
  if(e.target === modal) modal.classList.remove("open");
};

loadCollection();
</script>

</body>
</html>